# 容器网络

Linux 是通过网络设备去操作和使用网卡的，系统装了一个网卡之后会为其生成一个网络设备实例，比如 ethO。而随着网络虚拟化技术的发展，Linux 支持创建出虚
拟化的设备，可以通过虚拟化设备的组合实现多种多样的功能和网络拓扑。常见的虚拟化设备有 Veth、Bridge、802.1.q VLAN device、TAP 等。

## Veth
Veth 是成对出现的虚拟网络设备，发送到 Veth 一端虚拟设备的请求会从另一端的虚拟设备中发出。在容器的虚拟化场景中，经常会使用 Veth 连接不同的网络 Namespace。


## Bridge
Bridge 虚拟设备是用来桥接的网络设备，它相当于现实世界中的交换机，可以连接不同的网络设备，当请求到达 Bridge 设备时，可以通过报文中的 Mac 地址进行
广播或转发。

## Linux 路由表
路由表是 Linux 内核的一个模块，通过定义路由表来决定在某个网络 Namespace 中包的流向，从而定义请求会到哪个网络设备上。

## Linux iptables
iptables 是对 Linux 内核的 netfilter 模块进行操作的工具，用来管理网络包的流动和转发。

iptables 定义了一套链式处理结构，在网络报传输的各个阶段可以使用不同的策略对包进行加工，转发，丢弃。

在容器化技术中，经常会用到两种策略 MASQUERADE 和 DNAT，用户容器和宿主机外部的网络通信。

### MASQUERADE

MASQUERADE 策略可以将请求包中的元四肢转换成一个网络设备的地址。

比如 Namespace 中网络设备的地址是 `172.18.0.2`，这个地址虽然在宿主机上可以路由到 brO 的网桥，但是到
达宿主机外部之后，是不知道如何路由到这个 IP 地址的，所以如果请求外部地址的话，需要先通过 MASQUERADE 策略将这个 IP 转换成宿主机出口网
卡的 IP。

### DNAT

DNAT 策略也是做网络地址的转换，不过它是要更换目标地址，经常用于将内部网络地址的端口映射到外部去。比如，Namespace 中如果需要提供服务给
宿主机之外的应用去请求要怎么办呢？外部应用没办法直接路由到 `172.18.0.2` 这个地址，这时候就可以用到 DNAT 策略。

```bash
iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.18.0.2:80
```

这样就可以把宿主机上 80 端口的 TCP 请求转发到 Namespace 中的地址 `172.18.0.2:80`，从而实现外部的应用调用。

### IPAM

IPAM 也是网络功能中的一个组件，用于网络 IP 地址的分配和释放，包括容器的 IP 地址和网络网关的 IP 地址。
